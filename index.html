<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
  <style>
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    #canvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .metric {
      position: relative;
      background-color: #EEEEEE;
      border-color: #FFFFFF !important;
    }

    .metric .label {
      padding: 0px 10px;
      background-color: rgba(0,0,0,0.2);
      color: #FFF;
    }

    .metric .value {
      font-size: 7vw;
      color: #FFF;
    }

    .metric.temperature .value {
      color: #555;
    }

    .metric.humidity .value {
      color: #555;
    }

    .metric.aqi .value {
      font-size: 20vw;
    }

    .metric.grade1 {
      background-color: #007700;
    }

    .metric.grade2 {
      background-color: #EEBB00;
    }

    .metric.grade3 {
      background-color: #FF7E00;
    }

    .metric.grade4 {
      background-color: #FF0000;
    }

    .metric.grade5 {
      background-color: #99004c;
    }

    .metric.grade6 {
      background-color: #7e0023;
    }

    .metric.grade7 {
      background-color: #7e0023;
    }

    .metric.good {
      background-color: #007700;
    }

    .metric.poor {
      background-color: #EEAA00;
    }

    .metric.bad {
      background-color: #770000;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
  <script>
    let pm25RangeMap = [
      {
        readingRange: [0, 12],
        scoreRange: [0, 50],
        grade: 'grade1'
      },
      {
        readingRange: [12, 35.4],
        scoreRange: [50, 100],
        grade: 'grade2'
      },
      {
        readingRange: [35.4, 55.4],
        scoreRange: [100, 150],
        grade: 'grade3'
      },
      {
        readingRange: [55.4, 150.4],
        scoreRange: [150, 200],
        grade: 'grade4'
      },
      {
        readingRange: [150.4, 250.4],
        scoreRange: [200, 300],
        grade: 'grade5'
      },
      {
        readingRange: [250.4, 350.4],
        scoreRange: [300, 400],
        grade: 'grade6'
      },
      {
        readingRange: [350.4, Number.MAX_VALUE],
        scoreRange: [400, 500],
        grade: 'grade7'
      }
    ];

    let pm10RangeMap = [
      {
        readingRange: [0, 54],
        scoreRange: [0, 50],
        grade: 'grade1'
      },
      {
        readingRange: [54, 154],
        scoreRange: [50, 100],
        grade: 'grade2'
      },
      {
        readingRange: [154, 254],
        scoreRange: [100, 150],
        grade: 'grade3'
      },
      {
        readingRange: [254, 354],
        scoreRange: [150, 200],
        grade: 'grade4'
      },
      {
        readingRange: [354, 424],
        scoreRange: [200, 300],
        grade: 'grade5'
      },
      {
        readingRange: [424, 504],
        scoreRange: [300, 400],
        grade: 'grade6'
      },
      {
        readingRange: [504, Number.MAX_VALUE],
        scoreRange: [400, 500],
        grade: 'grade7'
      }
    ];

    function refreshUI() {
      let $aqi = $('.aqi');
      let $temperature = $('.temperature');
      let $humidity = $('.humidity');
      let $hcho = $('.hcho');
      let $pm25 = $('.pm25');
      let $pm40 = $('.pm40');
      let $pm10 = $('.pm10');

      $.get('index.json')
      .done((data) => {
        let temperatureReading = Math.round(data.temperature);
        let humidityReading = Math.round(data.humidity);
        let hchoReading = Math.round(data.hcho);
        
        let hchoClasses = 'good poor bad';
        if (hchoReading > 80) {
          $hcho.removeClass(hchoClasses).addClass('bad');
        }
        else if (hchoReading > 16) {
          $hcho.removeClass(hchoClasses).addClass('poor');
        }
        else {
          $hcho.removeClass(hchoClasses).addClass('good');
        }

        $temperature.find('.value').html(`${temperatureReading}°`);
        $humidity.find('.value').html(humidityReading);
        $hcho.find('.value').html(hchoReading);


        let pm25Reading = Math.round(data['pm2.5']);
        let pm40Reading = Math.round(data['pm4.0']);
        let pm10Reading = Math.round(data['pm10.0']);
        let gradeClasses = 'grade1 grade2 grade3 grade4 grade5 grade6 grade7';
        let aqiComponents = calculateAQIs(pm25Reading, pm40Reading, pm10Reading);

        $pm25.removeClass(gradeClasses).addClass(aqiComponents.pm25.bracket.grade).find('.value').html(pm25Reading);
        $pm40.removeClass(gradeClasses).addClass(aqiComponents.pm40.bracket.grade).find('.value').html(pm40Reading);
        $pm10.removeClass(gradeClasses).addClass(aqiComponents.pm10.bracket.grade).find('.value').html(pm10Reading);

        let maxAqiComponent = _.max(Object.values(aqiComponents), (item) => {
          return item.score;
        });
        $aqi.removeClass(gradeClasses).addClass(maxAqiComponent.bracket.grade).find('.value').html(maxAqiComponent.score);
      })
      .always(() => {
        setTimeout(refreshUI, 2000);
      });
    }

    function calculateAQIs(pm25Reading, pm40Reading, pm10Reading) {
      let pm25Bracket = _.find(pm25RangeMap, (item) => {
          return pm25Reading < item.readingRange[1];
      });
      let pm40Bracket = _.find(pm25RangeMap, (item) => {
          return pm40Reading < item.readingRange[1];
      });
      let pm10Bracket = _.find(pm10RangeMap, (item) => {
          return pm10Reading < item.readingRange[1];
      });

      return {
        pm25: {
          score: calculateAQI(pm25Reading, pm25Bracket),
          bracket: pm25Bracket
        },
        pm40: {
          score: calculateAQI(pm40Reading, pm40Bracket),
          bracket: pm40Bracket
        },
        pm10: {
          score: calculateAQI(pm10Reading, pm10Bracket),
          bracket: pm10Bracket
        }
      };
    }

    function calculateAQI(reading, bracket) {
      let scoreRangeLength = bracket.scoreRange[1]-bracket.scoreRange[0];
      let readingRangeLength = bracket.readingRange[1]-bracket.readingRange[0];
      let rangeMultiplier = scoreRangeLength/readingRangeLength;
      let readingPositionInRange = reading-bracket.readingRange[0];
      let score = (rangeMultiplier*readingPositionInRange) + bracket.scoreRange[0];

      return Math.round(score);
    }

    $(function() {
      refreshUI();
    });
  </script>
</head>
<body>
  <div id="canvas" class="d-flex flex-row">
    <div class="d-flex flex-row col-6 left">
      <div class="d-flex flex-column col-6 sfa30">
        <div class="d-flex flex-fill justify-content-center align-items-center border border-start-0 border-end-0 border-top-0 metric temperature">
          <small class="label position-absolute top-0 start-0">temperature</small>
          <div class="value fw-bold">0°</div>
        </div>
        <div class="d-flex flex-fill justify-content-center align-items-center border border-start-0 border-end-0 border-top-0 metric humidity">
          <small class="label position-absolute top-0 start-0">humidity</small>
          <div class="value fw-bold">0</div>
        </div>
        <div class="d-flex flex-fill justify-content-center align-items-center border border-start-0 border-end-0 border-top-0  border-bottom-0 metric hcho">
          <small class="label position-absolute top-0 start-0">hcho</small>
          <div class="value fw-bold">0</div>
        </div>
      </div>
      <div class="d-flex flex-column col-6 sps30">
        <div class="d-flex flex-fill justify-content-center align-items-center border border-top-0 metric pm25">
          <small class="label position-absolute top-0 start-0">pm2.5</small>
          <div class="value fw-bold">0°</div>
        </div>
        <div class="d-flex flex-fill justify-content-center align-items-center border border-top-0 metric pm40">
          <small class="label position-absolute top-0 start-0">pm4.0</small>
          <div class="value fw-bold">0</div>
        </div>
        <div class="d-flex flex-fill justify-content-center align-items-center border border-top-0  border-bottom-0 metric pm10">
          <small class="label position-absolute top-0 start-0">pm10</small>
          <div class="value fw-bold">0</div>
        </div>
      </div>
    </div>
    <div class="col-6 d-flex flex-column right">
      <div class="d-flex flex-row flex-fill justify-content-center align-items-center metric aqi">
        <small class="label position-absolute top-0 end-0">aqi</small>
        <div class="value fw-bold">0</div>
      </div>
    </div>
  </div>
</body>
</html>




